<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* üî• FIREBASE CONFIG YAKO HALISI */

const firebaseConfig = {
apiKey: "AIzaSyBrgOTZN04zoRlpDzOgHFlK_5HvJW6pxD0",
authDomain: "masjidshabaab.firebaseapp.com",
databaseURL: "https://masjidshabaab-default-rtdb.firebaseio.com/",
projectId: "masjidshabaab",
storageBucket: "masjidshabaab.firebasestorage.app",
messagingSenderId: "1069424481338",
appId: "1:1069424481338:web:4eebe45e31ec3c24aad103"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* üîê LOGIN PROTECTION */
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get("auth") !== "ok"){
window.location.href = "admin.html";
}

/* ================= LOAD AUDIO ================= */

window.onload = function(){
loadAudios();
};

function loadAudios(){

onValue(ref(db,"audios"),(snapshot)=>{
const list = document.getElementById("audioList");
list.innerHTML = "";

snapshot.forEach(child=>{

const data = child.val();

list.innerHTML += `
<div style="border:1px solid #ccc;padding:10px;margin:10px;">
<h4>${data.title}</h4>
<p>${data.category}</p>
<audio controls>
<source src="${data.audio}">
</audio>
<br><br>
<button onclick="deleteAudio('${child.key}')">Delete</button>
</div>
`;

});
});
}

window.deleteAudio = function(id){
remove(ref(db,"audios/"+id));
alert("Deleted ‚úÖ");
}

/* ================= UPLOAD ================= */

document.addEventListener("DOMContentLoaded", function(){

document.getElementById("uploadBtn").addEventListener("click", async function(e){

e.preventDefault();

const fileInput = document.getElementById("audioFile");
const title = document.getElementById("title").value;
const category = document.getElementById("category").value;
const file = fileInput.files[0];

if(!file){
alert("Select Audio File");
return;
}

const formData = new FormData();
formData.append("file", file);
formData.append("upload_preset", "ml_default"); // hakikisha preset ipo Cloudinary

try{

const response = await fetch(
"https://api.cloudinary.com/v1_1/drlltmnlb/upload",
{
method:"POST",
body:formData
}
);

const data = await response.json();

if(!data.secure_url){
alert("Upload Failed ‚ùå");
return;
}

const audioUrl = data.secure_url;

/* Save to Firebase */
push(ref(db,"audios"),{
title:title,
category:category,
audio:audioUrl
});

alert("Upload Success ‚úÖ");

fileInput.value = "";
document.getElementById("title").value = "";

}catch(error){
alert("Error: " + error.message);
console.log(error);
}

});

});

</script>

</head>
<body>

<h2>üî• Admin Dashboard</h2>

<h3>Upload Audio</h3>

<input type="text" id="title" placeholder="Audio Title"><br><br>

<select id="category">
<option value="Khutbah">Khutbah</option>
<option value="Jumamosi">Jumamosi</option>
<option value="Jumapili">Jumapili</option>
<option value="Ramadhani">Ramadhani</option>
</select><br><br>

<input type="file" id="audioFile" accept="audio/*"><br><br>

<button id="uploadBtn">Upload Audio</button>

<hr>

<h3>Audio List</h3>
<div id="audioList"></div>

</body>
</html>
