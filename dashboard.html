<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

/* ðŸ”¥ WEKA CONFIG YAKO HAPA */
const firebaseConfig = {
apiKey: "AIzaSyCP9rS5F84AuO5QFyGv355GLlKxrfF7UT4",
authDomain: "masjid-shabaab-daa-wah.firebaseapp.com",
projectId: "615883244718",
storageBucket: "masjid-shabaab-daa-wah.firebasestorage.app",
messagingSenderId: "G-NERS9HHKLE",
appId: "1:615883244718:web:d9970c4ae55cb247c6d93f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ðŸ” LOGIN PROTECTION */
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get("auth") !== "ok"){
window.location.href = "admin.html";
}

/* ================= LOAD AUDIO ================= */

window.loadAudios = async function(){

const querySnapshot = await getDocs(collection(db,"audios"));
const list = document.getElementById("audioList");
list.innerHTML = "";

querySnapshot.forEach((docSnap)=>{

const data = docSnap.data();

list.innerHTML += `
<div style="border:1px solid #ccc;padding:10px;margin:10px;">
<h4>${data.title}</h4>
<p>Category: ${data.category}</p>
<audio controls>
<source src="${data.audio}">
</audio>
<br><br>
<button onclick="deleteAudio('${docSnap.id}')">Delete</button>
</div>
`;

});

}

/* ================= DELETE ================= */

window.deleteAudio = async function(id){
await deleteDoc(doc(db,"audios",id));
alert("Deleted âœ…");
loadAudios();
}

window.onload = loadAudios;

</script>

</head>
<body>

<h2>ðŸ”¥ Admin Dashboard</h2>

<h3>Upload Audio</h3>

<input type="text" id="title" placeholder="Audio Title"><br><br>

<select id="category">
<option value="Khutbah">Khutbah</option>
<option value="Jumamosi">Jumamosi</option>
<option value="Jumapili">Jumapili</option>
<option value="Ramadhani">Ramadhani</option>
</select><br><br>

<input type="file" id="audioFile" accept="audio/*"><br><br>

<button onclick="saveAudio()">Save Audio</button>

<hr>

<h3>Filter</h3>
<select onchange="filterCategory(this.value)">
<option value="">All</option>
<option value="Khutbah">Khutbah</option>
<option value="Jumamosi">Jumamosi</option>
<option value="Jumapili">Jumapili</option>
<option value="Ramadhani">Ramadhani</option>
</select>

<hr>

<h3>Audio List</h3>
<div id="audioList"></div>

<hr>

<button onclick="window.location.href='admin.html'">Logout</button>

<script>

/* ================= SAVE AUDIO ================= */

async function saveAudio(){

const title = document.getElementById("title").value;
const category = document.getElementById("category").value;
const fileInput = document.getElementById("audioFile");
const file = fileInput.files[0];

if(!title){
alert("Enter Title");
return;
}

if(!file){
alert("Select Audio File");
return;
}

try{

const storageRef = ref(storage, "audios/" + Date.now() + "_" + file.name);

await uploadBytes(storageRef, file);
const url = await getDownloadURL(storageRef);

await addDoc(collection(db,"audios"),{
title:title,
category:category,
audio:url,
date:new Date().toISOString()
});

alert("Audio Uploaded âœ…");

fileInput.value = "";
document.getElementById("title").value = "";

loadAudios();

}catch(error){
console.log(error);
alert("Upload Failed âŒ");
}

}

/* ================= FILTER ================= */

async function filterCategory(category){

const querySnapshot = await getDocs(collection(db,"audios"));
const list = document.getElementById("audioList");
list.innerHTML = "";

querySnapshot.forEach((docSnap)=>{

const data = docSnap.data();

if(category === "" || data.category === category){

list.innerHTML += `
<div style="border:1px solid #ccc;padding:10px;margin:10px;">
<h4>${data.title}</h4>
<p>Category: ${data.category}</p>
<audio controls>
<source src="${data.audio}">
</audio>
<br><br>
<button onclick="deleteAudio('${docSnap.id}')">Delete</button>
</div>
`;

}

});
}

window.filterCategory = filterCategory;

</script>

</body>
</html>
